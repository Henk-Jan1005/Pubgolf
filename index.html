<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Team Golf & Challenges (Single Sheet)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; font-family: sans-serif; }
    nav {
      display: flex;
      justify-content: space-around;
      background-color: #0077cc;
      color: white;
      padding: 10px 0;
      position: sticky;
      top: 0;
    }
    nav button {
      background: none;
      border: none;
      color: white;
      font-size: 1em;
    }
    .tab { display: none; padding: 1em; }
    .tab.active { display: block; }
    input, select, button {
      display: block;
      margin: 10px 0;
      padding: 8px;
      width: 100%;
      font-size: 1em;
      box-sizing: border-box;
    }
    .hole-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 5px 0;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .hole-label {
      flex: 1;
    }
    .hole-buttons button {
      margin: 0 5px;
      padding: 5px 10px;
      font-size: 1em;
    }
    .golf-list div, .challenge-records div {
      background: #f4f4f4;
      margin: 5px 0;
      padding: 8px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <nav>
    <button onclick="showTab('edit')">Edit</button>
    <button onclick="showTab('view')">View</button>
    <button onclick="showTab('map')">Map</button>
    <button onclick="showTab('challenges')">Challenges</button>
  </nav>

  <div id="edit" class="tab active">
    <div id="loginSection">
      <h2>Login</h2>
      <input type="text" id="loginName" placeholder="Your name">
      <select id="teamSelect">
        <option value="">Select team</option>
        <option value="1">Team 1</option>
        <option value="2">Team 2</option>
        <option value="3">Team 3</option>
      </select>
      <button onclick="login()">Login</button>
    </div>

    <div id="editSection" style="display:none;">
      <h2>Welcome, <span id="displayName"></span> (Team <span id="displayTeam"></span>)</h2>
      <div id="golfScore">
        <h3>Golf Score Editor (9 Holes)</h3>
        <div id="golfEditor"></div>
        <button onclick="submitGolfScore()">Submit Golf Scores</button>
      </div>
    </div>
  </div>

  <div id="view" class="tab">
    <h2>View Records (Single Sheet)</h2>
    <h3>Golf Scores</h3>
    <div id="golfScores" class="golf-list"></div>
    <h3>Challenge Records</h3>
    <div id="challengeRecords" class="challenge-records"></div>
  </div>

  <div id="map" class="tab">
    <h2>Tap Map</h2>
    <p>Tap map coming soon...</p>
  </div>

  <div id="challenges" class="tab">
    <h2>Challenges</h2>
    <div id="challengeList"></div>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwayhFDwpUReTh9qUZP4z3Wyk9yuzgn1IgibiQpZgqj1NtbNrsxBddUsxwGZ6Bt-XuO/exec';

    let currentTeam = null;
    let currentName = null;
    let golfScores = Array(9).fill(0);

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      if (tabId === 'view') fetchAllData();
      if (tabId === 'challenges') loadChallenges();
    }

    function login() {
      const name = document.getElementById('loginName').value;
      const team = document.getElementById('teamSelect').value;
      if (name && team) {
        currentName = name;
        currentTeam = team;
        document.getElementById('displayName').textContent = name;
        document.getElementById('displayTeam').textContent = team;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('editSection').style.display = 'block';
        generateGolfEditor();
      } else {
        alert("Please enter your name and select a team.");
      }
    }

    function generateGolfEditor() {
      const editorDiv = document.getElementById('golfEditor');
      editorDiv.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'hole-row';

        const labelDiv = document.createElement('div');
        labelDiv.className = 'hole-label';
        labelDiv.textContent = 'Hole ' + (i + 1) + ': ';
        const scoreSpan = document.createElement('span');
        scoreSpan.id = 'hole' + (i + 1) + '_score';
        scoreSpan.textContent = golfScores[i];
        labelDiv.appendChild(scoreSpan);

        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'hole-buttons';

        const minusBtn = document.createElement('button');
        minusBtn.textContent = '-';
        minusBtn.onclick = () => updateHoleScore(i, -1);
        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.onclick = () => updateHoleScore(i, 1);

        buttonsDiv.appendChild(minusBtn);
        buttonsDiv.appendChild(plusBtn);
        rowDiv.appendChild(labelDiv);
        rowDiv.appendChild(buttonsDiv);
        editorDiv.appendChild(rowDiv);
      }
    }

    function updateHoleScore(index, delta) {
      golfScores[index] = Math.max(0, golfScores[index] + delta);
      document.getElementById('hole' + (index + 1) + '_score').textContent = golfScores[index];
    }

    function submitGolfScore() {
      fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: "submitGolf",
          team: currentTeam,
          name: currentName,
          golfScores: golfScores
        })
      })
      .then(res => res.text())
      .then(response => {
        alert(response);
        golfScores = Array(9).fill(0);
        generateGolfEditor();
      })
      .catch(err => console.error(err));
    }

    function fetchAllData() {
      fetch(scriptURL)
        .then(res => res.text())
        .then(text => {
          try {
            const data = JSON.parse(text);
            displayGolfScores(data);
            displayChallengeRecords(data);
          } catch (err) {
            console.error("Error parsing data", err);
          }
        })
        .catch(err => console.error("Fetch error", err));
    }

    function displayGolfScores(data) {
      const golfDiv = document.getElementById('golfScores');
      golfDiv.innerHTML = '';
      data.slice(1).reverse().forEach(row => {
        if (row[1] === "golf") {
          const holes = row.slice(4, 13).join(", ");
          const total = row[13];
          const div = document.createElement('div');
          div.textContent = `Team ${row[2]} - ${row[3]}: [${holes}] Total: ${total}`;
          golfDiv.appendChild(div);
        }
      });
    }

    function displayChallengeRecords(data) {
      const challengeDiv = document.getElementById('challengeRecords');
      challengeDiv.innerHTML = '';
      data.slice(1).reverse().forEach(row => {
        if (row[1] === "challenge") {
          const div = document.createElement('div');
          div.textContent = `Challenge ${row[14]}: ${row[15]} - Completed by ${row[3]} (Team ${row[2]}) [${row[16]} point]`;
          challengeDiv.appendChild(div);
        }
      });
    }

    function loadChallenges() {
      fetch(scriptURL)
        .then(res => res.text())
        .then(text => {
          let completed = {};
          try {
            const data = JSON.parse(text);
            data.slice(1).forEach(row => {
              if (row[1] === "challenge") completed[row[14]] = true;
            });
          } catch (err) {
            console.error("Error reading challenge data", err);
          }

          fetch("challenges.txt")
            .then(resp => resp.text())
            .then(fileText => {
              const lines = fileText.split('\n').filter(line => line.trim() !== "");
              const challengeListDiv = document.getElementById('challengeList');
              challengeListDiv.innerHTML = '';
              lines.forEach((challengeDesc, index) => {
                const challengeId = String(index + 1);
                const div = document.createElement('div');
                div.style.border = "1px solid #ccc";
                div.style.padding = "8px";
                div.style.marginBottom = "5px";
                const p = document.createElement('p');
                p.textContent = `Challenge ${challengeId}: ${challengeDesc}`;
                div.appendChild(p);
                const btn = document.createElement('button');
                if (completed[challengeId]) {
                  btn.textContent = "Completed";
                  btn.disabled = true;
                } else {
                  btn.textContent = "Complete Challenge";
                  btn.onclick = () => completeChallenge(challengeId, challengeDesc);
                }
                div.appendChild(btn);
                challengeListDiv.appendChild(div);
              });
            });
        });
    }

    function completeChallenge(challengeId, challengeDesc) {
      if (!currentName || !currentTeam) {
        alert("Please login on the Edit tab first.");
        return;
      }
      fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: "completeChallenge",
          challengeId: challengeId,
          challengeDesc: challengeDesc,
          name: currentName,
          team: currentTeam
        })
      })
      .then(res => res.text())
      .then(response => {
        alert(response);
        loadChallenges();
      })
      .catch(err => console.error(err));
    }

    setInterval(() => {
      if (document.getElementById('view').classList.contains('active')) {
        fetchAllData();
      }
    }, 10000);
  </script>
</body>
</html>
