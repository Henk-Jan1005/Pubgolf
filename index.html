<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <!-- Zorg voor goed schalen op mobiele apparaten -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PUBGOLF Scoreboard</title>
  <!-- Google Fonts en Material Icons -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* === JOUW STIJL === */
    html, body {
      margin: 0;
      padding: 0;
      background: url('your-background-image.jpg') no-repeat center center fixed,
                  linear-gradient(135deg, #74ABE2, #5563DE);
      background-size: cover;
      font-family: 'Roboto', sans-serif;
      color: #333;
    }
    #login-container {
      max-width: 600px;
      margin: 100px auto 30px;
      padding: 20px;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #login-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2575fc;
    }
    #login-container select,
    #login-container input,
    #login-container button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
    }
    #login-container button {
      background: #2575fc;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    #login-container button:hover {
      background: #1a5ecb;
    }
    #app {
      display: none;
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
    }
    nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      padding: 10px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    nav button {
      background: none;
      border: none;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    nav button:hover {
      transform: scale(1.1);
    }
    #content {
      padding: 10px;
      margin-top: 60px;
    }
    .page {
      display: none;
    }
    h2, h3 {
      text-align: center;
      margin-top: 0;
    }
    .player-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 20px;
    }
    .player-card label {
      display: block;
      margin: 8px 0 4px;
      font-weight: 500;
    }
    .player-card input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .hole-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 6px 0;
    }
    .hole-row span {
      flex: 1;
      font-weight: 500;
    }
    .score-display {
      width: 40px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
    .btn-adjust {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border: none;
      background: #2575fc;
      color: #fff;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s;
    }
    .btn-adjust:active {
      background: #1a5ecb;
    }
    .player-total {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
      font-weight: 500;
    }
    .group-card {
      background: #fff;
      border-radius: 12px;
      margin: 15px 0;
      padding: 15px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .group-card:hover {
      transform: scale(1.02);
    }
    .group-card h3 {
      margin-bottom: 10px;
      color: #2575fc;
    }
    .score-item {
      font-size: 16px;
      margin: 4px 0;
    }
    .chart-container {
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
    }
    .challenge-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 15px;
    }
    .challenge-card p {
      margin: 0 0 8px;
      font-weight: 500;
    }
    .challenge-card button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      background: #28a745;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .challenge-card button:hover {
      background: #218838;
    }
    .challenge-completed {
      font-weight: bold;
      color: #28a745;
      text-align: center;
    }
    #mapPage p {
      text-align: center;
      font-size: 18px;
      padding: 20px;
    }
    @media (max-width: 600px) {
      nav button {
        font-size: 24px;
      }
      .btn-adjust {
        width: 36px;
        height: 36px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Sectie -->
  <div id="login-container">
    <h2>Papi bamgia</h2>
    <select id="groupSelect">
      <option value="group1">Group 1 (3 drinking players)</option>
      <option value="group2">Group 2 (2 drinking players)</option>
      <option value="group3">Group 3 (2 drinking players)</option>
    </select>
    <input type="password" id="password" placeholder="Enter password">
    <button onclick="login()">Login</button>
  </div>
  
  <!-- Main App Container -->
  <div id="app">
    <!-- Navigatiebalk -->
    <nav>
      <button onclick="showPage('editScorePage')" title="Edit Score">
        <span class="material-icons">edit</span>
      </button>
      <button onclick="showPage('viewScoresPage')" title="View Scores">
        <span class="material-icons">bar_chart</span>
      </button>
      <button onclick="showPage('mapPage')" title="Map">
        <span class="material-icons">map</span>
      </button>
      <button onclick="showPage('challengesPage')" title="Challenges">
        <span class="material-icons">emoji_events</span>
      </button>
      <button onclick="clearData()" title="Clear Data">
        <span class="material-icons">delete_forever</span>
      </button>
    </nav>
    
    <!-- Content Area -->
    <div id="content">
      <!-- Edit Score Page -->
      <div id="editScorePage" class="page">
        <h2>Edit Score - <span id="editGroupTitle"></span></h2>
        <div id="editScoreContent"></div>
      </div>
      
      <!-- View Scores Page -->
      <div id="viewScoresPage" class="page">
        <h2>View All Scores</h2>
        <div class="chart-container">
          <canvas id="scoreChart"></canvas>
        </div>
        <div id="viewScoresContent"></div>
      </div>
      
      <!-- Map Page -->
      <div id="mapPage" class="page">
        <h2>Map</h2>
        <p>Map coming soon.</p>
      </div>
      
      <!-- Challenges Page -->
      <div id="challengesPage" class="page">
        <h2>Challenges</h2>
        <div id="challengesContent"></div>
      </div>
    </div>
  </div>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    /***************************************************************
     * Configuratie voor Railway backend (PostgreSQL)
     * Zorg dat de URL begint met https://
     ***************************************************************/
    const apiUrl = "https://railway-production-596f.up.railway.app";
    
    /***************************************************************
     * Globale Configuratie
     ***************************************************************/
    const groupData = {
      group1: { password: "Thobias1", players: 3, title: "Group 1" },
      group2: { password: "Thobias2", players: 2, title: "Group 2" },
      group3: { password: "Thobias3", players: 2, title: "Group 3" }
    };
    
    let currentGroup = "";
    let scoreboard = []; // Array met spelers: { player_index, name, scores: [9 nummers] }
    let challenges = {}; // Object: { "Challenge Name": { completedBy: groupId of null } }
    let scoreChart;
    let isScoreboardInitialized = false;  // Flag om te weten of we al hebben geïnitialiseerd
    
    /***************************************************************
     * Data ophalen en opslaan via de API
     ***************************************************************/
    // Haal scoreboard op voor de huidige groep
    function loadScoreboard(group = currentGroup) {
      fetch(apiUrl + "/scoreboards/" + group)
        .then(response => response.json())
        .then(data => {
          if (Array.isArray(data)) {
            // Eerste keer: als er nog geen data bestaat, initialiseer dan
            if (!isScoreboardInitialized) {
              if (data.length === 0) {
                initScoreboard(group);
              } else {
                scoreboard = data;
              }
              isScoreboardInitialized = true;
            } else {
              // Als we al geïnitialiseerd zijn, werk de lokale data alleen bij als de response niet leeg is
              if (data.length > 0) {
                scoreboard = data;
              }
            }
          }
          renderEditScorePage();
        })
        .catch(error => {
          console.error("Error loading scoreboard:", error);
          renderEditScorePage();
        });
    }
    
    // Initialiseer een nieuw scoreboard en sla dit op
    function initScoreboard(group = currentGroup) {
      scoreboard = [];
      const numPlayers = groupData[group].players;
      for (let i = 0; i < numPlayers; i++) {
        scoreboard.push({
          player_index: i,
          name: "Player " + (i + 1),
          scores: Array(9).fill(0)
        });
      }
      saveScoreboardToDB();
    }
    
    // Sla het scoreboard op via de API
    function saveScoreboardToDB() {
      fetch(apiUrl + "/scoreboards/" + currentGroup, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scoreboard)
      })
      .then(response => response.json())
      .then(data => console.log("Scoreboard saved", data))
      .catch(error => console.error("Error saving scoreboard:", error));
    }
    
    // Haal challenges op via de API
    function fetchChallenges() {
      fetch(apiUrl + "/challenges")
        .then(response => response.json())
        .then(data => {
          challenges = data || {};
          renderChallengesPage();
        })
        .catch(error => console.error("Error fetching challenges:", error));
    }
    
    // Sla challenges op via de API
    function saveChallengesToDB() {
      fetch(apiUrl + "/challenges", {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(challenges)
      })
      .then(response => response.json())
      .then(data => console.log("Challenges saved", data))
      .catch(error => console.error("Error saving challenges:", error));
    }
    
    // Verwijder data voor de huidige groep en globale challenges
    function clearData() {
      if (confirm("Are you sure you want to clear all data? This will remove all scores and challenge completions.")) {
        fetch(apiUrl + "/scoreboards/" + currentGroup, { method: 'DELETE' })
          .then(() => fetch(apiUrl + "/challenges", { method: 'DELETE' }))
          .then(() => {
            alert("Data cleared. The page will now reload.");
            location.reload();
          })
          .catch(error => console.error("Error clearing data:", error));
      }
    }
    
    /***************************************************************
     * Polling (optioneel): Ververs elke 5 seconden de data
     ***************************************************************/
    function pollData() {
      setInterval(() => {
        loadScoreboard(currentGroup);
        fetchChallenges();
      }, 5000);
    }
    
    /***************************************************************
     * Login en navigatie functies
     ***************************************************************/
    function login() {
      const selectedGroup = document.getElementById('groupSelect').value;
      const enteredPassword = document.getElementById('password').value;
      if (enteredPassword === groupData[selectedGroup].password) {
        currentGroup = selectedGroup;
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('editGroupTitle').textContent = groupData[currentGroup].title;
        loadScoreboard(currentGroup);
        fetchChallenges();
        pollData();  // Start polling na login
        showPage('editScorePage');
      } else {
        alert("Incorrect password. Please try again.");
      }
    }
    
    function showPage(pageId) {
      const pages = document.getElementsByClassName('page');
      for (let page of pages) {
        page.style.display = 'none';
      }
      document.getElementById(pageId).style.display = 'block';
      if (pageId === 'editScorePage') {
        renderEditScorePage();
      } else if (pageId === 'viewScoresPage') {
        renderViewScoresPage();
      } else if (pageId === 'challengesPage') {
        renderChallengesPage();
      }
    }
    
    /***************************************************************
     * Render functies
     ***************************************************************/
    // Render de Edit Score pagina
    function renderEditScorePage() {
      let html = '';
      scoreboard.forEach((player, pIndex) => {
        html += '<div class="player-card">';
        html += '<label>Player Name: <input type="text" value="'+ player.name +'" onchange="updatePlayerName('+ pIndex +', this.value)" /></label>';
        for (let i = 0; i < 9; i++) {
          html += '<div class="hole-row">';
          html += '<span>Hole ' + (i+1) + ':</span>';
          html += '<button class="btn-adjust" onclick="decrementScore('+ pIndex +', '+ i +')">–</button>';
          html += '<span class="score-display">' + player.scores[i] + '</span>';
          html += '<button class="btn-adjust" onclick="incrementScore('+ pIndex +', '+ i +')">+</button>';
          html += '</div>';
        }
        let playerTotal = player.scores.reduce((a, b) => a + Number(b), 0);
        html += '<p class="player-total">Player Total: ' + playerTotal + '</p>';
        html += '</div>';
      });
      const teamTotal = computeTeamTotal();
      html += '<p style="text-align:center; font-size:20px; font-weight:bold; color:#2575fc;">Team Final Score: ' + teamTotal + '</p>';
      document.getElementById('editScoreContent').innerHTML = html;
    }
    
    function updatePlayerName(index, newName) {
      scoreboard[index].name = newName;
      saveScoreboardToDB();
      renderEditScorePage();
    }
    
    function incrementScore(playerIndex, holeIndex) {
      scoreboard[playerIndex].scores[holeIndex] = Number(scoreboard[playerIndex].scores[holeIndex]) + 1;
      saveScoreboardToDB();
      renderEditScorePage();
    }
    
    function decrementScore(playerIndex, holeIndex) {
      scoreboard[playerIndex].scores[holeIndex] = Math.max(0, Number(scoreboard[playerIndex].scores[holeIndex]) - 1);
      saveScoreboardToDB();
      renderEditScorePage();
    }
    
    // Bereken het teamtotaal
    function computeTeamTotal() {
      let total = 0;
      scoreboard.forEach(player => {
        total += player.scores.reduce((a, b) => a + Number(b), 0);
      });
      let challengeCount = 0;
      for (let ch in challenges) {
        if (challenges[ch].completedBy === currentGroup) {
          challengeCount++;
        }
      }
      return total - challengeCount;
    }
    
    // Render de View Scores pagina
    function renderViewScoresPage() {
      let html = '';
      const groups = Object.keys(groupData);
      let groupsProcessed = 0;
      groups.forEach(group => {
        fetch(apiUrl + "/scoreboards/" + group)
          .then(response => response.json())
          .then(groupScoreboard => {
            if (!groupScoreboard) {
              groupsProcessed++;
              if (groupsProcessed === groups.length) updateChart();
              return;
            }
            let teamTotal = 0;
            groupScoreboard.forEach(player => {
              teamTotal += player.scores.reduce((a, b) => a + Number(b), 0);
            });
            let challengeCount = 0;
            for (let ch in challenges) {
              if (challenges[ch].completedBy === group) {
                challengeCount++;
              }
            }
            teamTotal -= challengeCount;
            html += '<div class="group-card">';
            html += '<h3>' + groupData[group].title + ' (Final Score: ' + teamTotal + ')</h3>';
            groupScoreboard.forEach(player => {
              const playerTotal = player.scores.reduce((a, b) => a + Number(b), 0);
              html += '<div class="score-item">' + player.name + ' – Score: ' + playerTotal + '</div>';
            });
            html += '</div>';
            groupsProcessed++;
            if (groupsProcessed === groups.length) {
              document.getElementById('viewScoresContent').innerHTML = html;
              updateChart();
            }
          })
          .catch(error => {
            console.error("Error fetching group", group, error);
            groupsProcessed++;
            if (groupsProcessed === groups.length) {
              document.getElementById('viewScoresContent').innerHTML = html;
              updateChart();
            }
          });
      });
    }
    
    // Render de Challenges pagina
    function renderChallengesPage() {
      let html = '';
      for (let challenge in challenges) {
        html += '<div class="challenge-card">';
        html += '<p><strong>' + challenge + '</strong></p>';
        if (challenges[challenge].completedBy === null) {
          html += '<button onclick="confirmChallenge(\''+ challenge +'\')">Complete Challenge</button>';
        } else {
          html += '<p class="challenge-completed">Completed by: ' + groupData[challenges[challenge].completedBy].title + '</p>';
        }
        html += '</div>';
      }
      document.getElementById('challengesContent').innerHTML = html;
    }
    
    function confirmChallenge(challengeName) {
      if (confirm("Are you sure you want to complete \"" + challengeName + "\"? This action cannot be undone.")) {
        challenges[challengeName].completedBy = currentGroup;
        saveChallengesToDB();
        alert("Challenge \"" + challengeName + "\" completed by " + groupData[currentGroup].title + "!");
        renderChallengesPage();
        renderEditScorePage();
      }
    }
    
    // Chart: Update Chart (View Scores Page)
    function updateChart() {
      const labels = [];
      const data = [];
      const groups = Object.keys(groupData);
      let groupsProcessed = 0;
      groups.forEach(group => {
        fetch(apiUrl + "/scoreboards/" + group)
          .then(response => response.json())
          .then(groupScoreboard => {
            if (!groupScoreboard) {
              groupsProcessed++;
              if (groupsProcessed === groups.length) drawChart(labels, data);
              return;
            }
            let teamTotal = 0;
            groupScoreboard.forEach(player => {
              teamTotal += player.scores.reduce((a, b) => a + Number(b), 0);
            });
            let challengeCount = 0;
            for (let ch in challenges) {
              if (challenges[ch].completedBy === group) {
                challengeCount++;
              }
            }
            teamTotal -= challengeCount;
            labels.push(groupData[group].title);
            data.push(teamTotal);
            groupsProcessed++;
            if (groupsProcessed === groups.length) drawChart(labels, data);
          })
          .catch(error => {
            console.error("Error updating chart for group", group, error);
            groupsProcessed++;
            if (groupsProcessed === groups.length) drawChart(labels, data);
          });
      });
    }
    
    function drawChart(labels, data) {
      const ctx = document.getElementById('scoreChart').getContext('2d');
      if (scoreChart) { scoreChart.destroy(); }
      scoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Team Final Score',
            data: data,
            backgroundColor: 'rgba(37, 117, 252, 0.7)'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
