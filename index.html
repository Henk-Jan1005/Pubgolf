<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <!-- Ensure proper scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PUBGOLF Scoreboard</title>
  <!-- Google Fonts and Material Icons -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* (Your CSS remains unchanged) */
  </style>
</head>
<body>
  <!-- (Your HTML body remains largely unchanged) -->
  <div id="login-container">
    <h2>Login</h2>
    <select id="groupSelect">
      <option value="group1">Group 1 (3 drinking players)</option>
      <option value="group2">Group 2 (2 drinking players)</option>
      <option value="group3">Group 3 (2 drinking players)</option>
    </select>
    <input type="password" id="password" placeholder="Enter password">
    <button onclick="login()">Login</button>
  </div>
  
  <div id="app" style="display:none;">
    <!-- Fixed Navbar, Content Areas, etc. -->
    <!-- (Same HTML for navigation and content pages as before) -->
  </div>
  
  <!-- Include Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Set your API URL here (the one you provided)
    const API_URL = "https://script.google.com/macros/s/AKfycbwayhFDwpUReTh9qUZP4z3Wyk9yuzgn1IgibiQpZgqj1NtbNrsxBddUsxwGZ6Bt-XuO/exec";

    /* ---------------------------
       Global Configuration
    ---------------------------- */
    const groupData = {
      group1: { password: "Thobias1", players: 3, title: "Group 1" },
      group2: { password: "Thobias2", players: 2, title: "Group 2" },
      group3: { password: "Thobias3", players: 2, title: "Group 3" }
    };

    let currentGroup = "";
    let scoreboard = []; // Array of player objects: { name: "", scores: [9 numbers] }
    let challenges = {};

    // ---------------------------
    // API-Based Data Persistence Functions
    // ---------------------------
    function saveScoreboardToSheet() {
      fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'saveScoreboard',
          group: currentGroup,
          scoreboard: scoreboard
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log("Scoreboard saved:", data);
      })
      .catch(err => console.error(err));
    }

    function loadScoreboardFromSheet() {
      fetch(`${API_URL}?action=loadScoreboard&group=${currentGroup}`)
      .then(response => response.json())
      .then(data => {
        if (data.scoreboard) {
          scoreboard = data.scoreboard;
        } else {
          initScoreboard(currentGroup);
        }
        renderEditScorePage();
      })
      .catch(err => console.error(err));
    }

    function saveChallengesToSheet() {
      fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'saveChallenges',
          challenges: challenges
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log("Challenges saved:", data);
      })
      .catch(err => console.error(err));
    }

    function loadChallengesFromSheet() {
      fetch(`${API_URL}?action=loadChallenges`)
      .then(response => response.json())
      .then(data => {
        if (data.challenges) {
          challenges = data.challenges;
          renderChallengesPage();
        } else {
          // Fallback: load from challenges.txt
          fetch("challenges.txt")
            .then(response => response.text())
            .then(text => {
              challenges = {};
              const lines = text.split('\n');
              lines.forEach(line => {
                let challenge = line.trim();
                if (challenge) {
                  challenges[challenge] = { completedBy: null };
                }
              });
              saveChallengesToSheet();
              renderChallengesPage();
            })
            .catch(err => {
              console.error("Error loading challenges.txt:", err);
              challenges = {};
            });
        }
      })
      .catch(err => console.error(err));
    }

    function clearSavedData() {
      if (confirm("Are you sure you want to clear all saved data? This will remove all scores and challenge completions.")) {
        fetch(`${API_URL}?action=clearDatabase`)
          .then(response => response.json())
          .then(data => {
            alert("Saved data cleared. The page will now reload.");
            location.reload();
          })
          .catch(err => console.error(err));
      }
    }

    // ---------------------------
    // Scoreboard Initialization and Calculation
    // ---------------------------
    function initScoreboard(group = currentGroup) {
      scoreboard = [];
      const numPlayers = groupData[group].players;
      for (let i = 0; i < numPlayers; i++) {
        scoreboard.push({
          name: "Player " + (i + 1),
          scores: Array(9).fill(0)
        });
      }
      saveScoreboardToSheet();
    }

    function computeTeamTotal(scoreboard) {
      let total = 0;
      scoreboard.forEach(player => {
        total += player.scores.reduce((a, b) => a + Number(b), 0);
      });
      let challengeCount = 0;
      for (let ch in challenges) {
        if (challenges[ch].completedBy === currentGroup) {
          challengeCount++;
        }
      }
      return total - challengeCount;
    }

    // ---------------------------
    // Login and Navigation Functions
    // ---------------------------
    function login() {
      const selectedGroup = document.getElementById('groupSelect').value;
      const enteredPassword = document.getElementById('password').value;
      if (enteredPassword === groupData[selectedGroup].password) {
        currentGroup = selectedGroup;
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('editGroupTitle').textContent = groupData[currentGroup].title;
        loadScoreboardFromSheet();
        loadChallengesFromSheet();
        showPage('editScorePage');
      } else {
        alert("Incorrect password. Please try again.");
      }
    }

    function showPage(pageId) {
      const pages = document.getElementsByClassName('page');
      for (let page of pages) {
        page.style.display = 'none';
      }
      document.getElementById(pageId).style.display = 'block';
      if (pageId === 'editScorePage') {
        renderEditScorePage();
      } else if (pageId === 'viewScoresPage') {
        renderViewScoresPage();
      } else if (pageId === 'challengesPage') {
        renderChallengesPage();
      }
    }

    // ---------------------------
    // Edit Score Page Functions
    // ---------------------------
    function renderEditScorePage() {
      let html = '';
      scoreboard.forEach((player, pIndex) => {
        html += '<div class="player-card">';
        html += '<label>Player Name: <input type="text" value="'+ player.name +'" onchange="updatePlayerName('+ pIndex +', this.value)" /></label>';
        for (let i = 0; i < 9; i++) {
          html += '<div class="hole-row">';
          html += '<span>Hole ' + (i+1) + ':</span>';
          html += '<button class="btn-adjust" onclick="decrementScore('+ pIndex +', '+ i +')">â€“</button>';
          html += '<span class="score-display">' + player.scores[i] + '</span>';
          html += '<button class="btn-adjust" onclick="incrementScore('+ pIndex +', '+ i +')">+</button>';
          html += '</div>';
        }
        let playerTotal = player.scores.reduce((a, b) => a + Number(b), 0);
        html += '<p class="player-total">Player Total: ' + playerTotal + '</p>';
        html += '</div>';
      });
      const teamTotal = computeTeamTotal(scoreboard);
      html += '<p style="text-align:center; font-size:20px; font-weight:bold; color:#2575fc;">Team Final Score: ' + teamTotal + '</p>';
      document.getElementById('editScoreContent').innerHTML = html;
    }

    function updatePlayerName(index, newName) {
      scoreboard[index].name = newName;
      saveScoreboardToSheet();
      renderEditScorePage();
    }

    function incrementScore(playerIndex, holeIndex) {
      scoreboard[playerIndex].scores[holeIndex] = Number(scoreboard[playerIndex].scores[holeIndex]) + 1;
      saveScoreboardToSheet();
      renderEditScorePage();
    }

    function decrementScore(playerIndex, holeIndex) {
      scoreboard[playerIndex].scores[holeIndex] = Math.max(0, Number(scoreboard[playerIndex].scores[holeIndex]) - 1);
      saveScoreboardToSheet();
      renderEditScorePage();
    }

    // ---------------------------
    // View Scores and Challenges Page Functions
    // ---------------------------
    function renderViewScoresPage() {
      let html = '';
      for (let group in groupData) {
        // For simplicity, this example still uses localStorage as a fallback.
        let groupScoreboard = JSON.parse(localStorage.getItem('pubgolfScoreboard_' + group) || 'null');
        if (!groupScoreboard) continue;
        let teamTotal = 0;
        groupScoreboard.forEach(player => {
          teamTotal += player.scores.reduce((a, b) => a + Number(b), 0);
        });
        let challengeCount = 0;
        for (let ch in challenges) {
          if (challenges[ch].completedBy === group) {
            challengeCount++;
          }
        }
        teamTotal -= challengeCount;
        html += '<div class="group-card">';
        html += '<h3>' + groupData[group].title + ' (Final Score: ' + teamTotal + ')</h3>';
        groupScoreboard.forEach(player => {
          const playerTotal = player.scores.reduce((a, b) => a + Number(b), 0);
          html += '<div class="score-item">' + player.name + ' â€“ Score: ' + playerTotal + '</div>';
        });
        html += '</div>';
      }
      document.getElementById('viewScoresContent').innerHTML = html;
      updateChart();
    }

    function renderChallengesPage() {
      let html = '';
      for (let challenge in challenges) {
        html += '<div class="challenge-card">';
        html += '<p><strong>' + challenge + '</strong></p>';
        if (challenges[challenge].completedBy === null) {
          html += '<button onclick="confirmChallenge(\''+ challenge +'\')">Complete Challenge</button>';
        } else {
          html += '<p class="challenge-completed">Completed by: ' + groupData[challenges[challenge].completedBy].title + '</p>';
        }
        html += '</div>';
      }
      document.getElementById('challengesContent').innerHTML = html;
    }

    function confirmChallenge(challengeName) {
      if (confirm("Are you sure you want to complete \"" + challengeName + "\"? This action cannot be undone.")) {
        challenges[challengeName].completedBy = currentGroup;
        saveChallengesToSheet();
        alert("Challenge \"" + challengeName + "\" completed by " + groupData[currentGroup].title + "!");
        renderChallengesPage();
        renderEditScorePage();
      }
    }

    // ---------------------------
    // Chart Update Function
    // ---------------------------
    let scoreChart;
    function updateChart() {
      const labels = [];
      const data = [];
      for (let group in groupData) {
        let groupScoreboard = JSON.parse(localStorage.getItem('pubgolfScoreboard_' + group) || 'null');
        if (!groupScoreboard) continue;
        let teamTotal = 0;
        groupScoreboard.forEach(player => {
          teamTotal += player.scores.reduce((a, b) => a + Number(b), 0);
        });
        let challengeCount = 0;
        for (let ch in challenges) {
          if (challenges[ch].completedBy === group) {
            challengeCount++;
          }
        }
        teamTotal -= challengeCount;
        labels.push(groupData[group].title);
        data.push(teamTotal);
      }
      
      const ctx = document.getElementById('scoreChart').getContext('2d');
      if (scoreChart) { scoreChart.destroy(); }
      scoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Team Final Score',
            data: data,
            backgroundColor: 'rgba(37, 117, 252, 0.7)'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          }
        }
      });
    }

    // ---------------------------
    // Auto-Save Interval
    // ---------------------------
    setInterval(function(){
      if (currentGroup) {
        saveScoreboardToSheet();
        saveChallengesToSheet();
      }
    }, 30000);
  </script>
</body>
</html>
