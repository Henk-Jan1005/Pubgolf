<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Team Golf Score Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; font-family: sans-serif; }
    nav {
      display: flex;
      justify-content: space-around;
      background-color: #0077cc;
      color: white;
      padding: 10px 0;
      position: sticky;
      top: 0;
    }
    nav button {
      background: none;
      border: none;
      color: white;
      font-size: 1em;
    }
    .tab { display: none; padding: 1em; }
    .tab.active { display: block; }
    input, select, button {
      display: block;
      margin: 10px 0;
      padding: 8px;
      width: 100%;
      font-size: 1em;
      box-sizing: border-box;
    }
    .hole-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 5px 0;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .hole-label {
      flex: 1;
    }
    .hole-buttons button {
      margin: 0 5px;
      padding: 5px 10px;
      font-size: 1em;
    }
    .golf-list div, .challenge-records div {
      background: #f4f4f4;
      margin: 5px 0;
      padding: 8px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <nav>
    <button onclick="showTab('edit')">Edit</button>
    <button onclick="showTab('view')">View</button>
    <button onclick="showTab('map')">Map</button>
    <button onclick="showTab('challenges')">Challenges</button>
  </nav>

  <!-- Edit Tab -->
  <div id="edit" class="tab active">
    <div id="loginSection">
      <h2>Login</h2>
      <input type="text" id="loginName" placeholder="Your name">
      <select id="teamSelect">
        <option value="">Select team</option>
        <option value="1">Team 1</option>
        <option value="2">Team 2</option>
        <option value="3">Team 3</option>
      </select>
      <button onclick="login()">Login</button>
    </div>

    <div id="editSection" style="display:none;">
      <h2>Welcome, <span id="displayName"></span> (Team <span id="displayTeam"></span>)</h2>

      <!-- Golf Score Editor -->
      <div id="golfScore">
        <h3>Golf Score Editor (9 Holes)</h3>
        <div id="golfEditor"></div>
        <button onclick="submitGolfScore()">Submit Golf Scores</button>
      </div>
    </div>
  </div>

  <!-- View Tab -->
  <div id="view" class="tab">
    <h2>View Records</h2>
    <h3>Golf Scores</h3>
    <div id="golfScores" class="golf-list"></div>
    
    <h3>Challenge Records</h3>
    <div id="challengeRecords" class="challenge-records"></div>
  </div>

  <!-- Map Tab -->
  <div id="map" class="tab">
    <h2>Tap Map</h2>
    <p>Tap map coming soon...</p>
  </div>

  <!-- Challenges Tab -->
  <div id="challenges" class="tab">
    <h2>Challenges</h2>
    <div id="challengeList"></div>
  </div>

  <script>
    // Use your actual Apps Script Web App URL here:
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwayhFDwpUReTh9qUZP4z3Wyk9yuzgn1IgibiQpZgqj1NtbNrsxBddUsxwGZ6Bt-XuO/exec';

    let currentTeam = null;
    let currentName = null;
    let golfScores = Array(9).fill(0);

    // On page load, we show "Edit" tab by default
    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      
      if (tabId === 'view') {
        fetchGolfScores();
        fetchChallengeRecords();
      }
      if (tabId === 'challenges') {
        loadChallenges();
      }
    }

    function login() {
      const name = document.getElementById('loginName').value;
      const team = document.getElementById('teamSelect').value;
      if (name && team) {
        currentName = name;
        currentTeam = team;
        document.getElementById('displayName').textContent = name;
        document.getElementById('displayTeam').textContent = team;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('editSection').style.display = 'block';
        generateGolfEditor();
      } else {
        alert("Please enter your name and select a team.");
      }
    }

    // Build the vertical golf editor (9 holes, default 0, +/â€“ buttons)
    function generateGolfEditor() {
      const editorDiv = document.getElementById('golfEditor');
      editorDiv.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'hole-row';
        
        const labelDiv = document.createElement('div');
        labelDiv.className = 'hole-label';
        labelDiv.textContent = 'Hole ' + (i + 1) + ': ';
        
        const scoreSpan = document.createElement('span');
        scoreSpan.id = 'hole' + (i + 1) + '_score';
        scoreSpan.textContent = golfScores[i];
        labelDiv.appendChild(scoreSpan);
        
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'hole-buttons';
        
        const minusBtn = document.createElement('button');
        minusBtn.textContent = '-';
        minusBtn.onclick = () => updateHoleScore(i, -1);
        
        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.onclick = () => updateHoleScore(i, 1);
        
        buttonsDiv.appendChild(minusBtn);
        buttonsDiv.appendChild(plusBtn);
        
        rowDiv.appendChild(labelDiv);
        rowDiv.appendChild(buttonsDiv);
        
        editorDiv.appendChild(rowDiv);
      }
    }

    // Increase/decrease hole score, not going below 0
    function updateHoleScore(index, delta) {
      golfScores[index] = Math.max(0, golfScores[index] + delta);
      document.getElementById('hole' + (index + 1) + '_score').textContent = golfScores[index];
    }

    // POST the golf scores to the script
    function submitGolfScore() {
      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({
          action: "submitGolf",
          team: currentTeam,
          name: currentName,
          golfScores: golfScores
        })
      })
      .then(res => res.text())
      .then(response => {
        alert(response);
        // Optionally reset scores to 0 after submission:
        golfScores = Array(9).fill(0);
        generateGolfEditor();
      })
      .catch(err => console.error(err));
    }

    // GET golf scores from the sheet
    function fetchGolfScores() {
      fetch(scriptURL + '?sheet=golf')
        .then(res => res.text())
        .then(text => {
          try {
            const data = JSON.parse(text);
            const golfDiv = document.getElementById('golfScores');
            golfDiv.innerHTML = '';
            // data[0] is headers; skip it with slice(1)
            data.slice(1).reverse().forEach(row => {
              // row = [Timestamp, Team, Name, Hole1,...,Hole9, Total]
              const holes = row.slice(3, 12).join(", ");
              const total = row[12];
              const div = document.createElement('div');
              div.textContent = `Team ${row[1]} - ${row[2]}: [${holes}] Total: ${total}`;
              golfDiv.appendChild(div);
            });
          } catch (err) {
            console.error("Error parsing golf scores", err);
          }
        });
    }

    // GET challenge records from the sheet
    function fetchChallengeRecords() {
      fetch(scriptURL + '?sheet=challenges')
        .then(res => res.text())
        .then(text => {
          try {
            const data = JSON.parse(text);
            const challengeRecordsDiv = document.getElementById('challengeRecords');
            challengeRecordsDiv.innerHTML = '';
            data.slice(1).reverse().forEach(row => {
              // row: [Timestamp, Challenge ID, Desc, Completed By, Team, Score Adj]
              const div = document.createElement('div');
              div.textContent = `Challenge ${row[1]}: ${row[2]} - Completed by ${row[3]} (Team ${row[4]}) [${row[5]} point]`;
              challengeRecordsDiv.appendChild(div);
            });
          } catch (err) {
            console.error("Error parsing challenge records", err);
          }
        });
    }

    // Load challenges from local challenges.txt and show which are completed
    function loadChallenges() {
      // First, fetch completed challenges from the sheet
      fetch(scriptURL + '?sheet=challenges')
        .then(res => res.text())
        .then(text => {
          let completed = {};
          try {
            const data = JSON.parse(text);
            data.slice(1).forEach(row => {
              completed[row[1]] = true; // row[1] is the challenge ID
            });
          } catch (err) {
            console.error("Error reading challenges sheet", err);
          }
          // Then load local file
          fetch("challenges.txt")
            .then(resp => resp.text())
            .then(fileText => {
              const lines = fileText.split('\n').filter(line => line.trim() !== "");
              const challengeListDiv = document.getElementById('challengeList');
              challengeListDiv.innerHTML = '';
              lines.forEach((challengeDesc, index) => {
                const challengeId = String(index + 1);
                const div = document.createElement('div');
                div.style.border = "1px solid #ccc";
                div.style.padding = "8px";
                div.style.marginBottom = "5px";
                const p = document.createElement('p');
                p.textContent = `Challenge ${challengeId}: ${challengeDesc}`;
                div.appendChild(p);
                const btn = document.createElement('button');
                if (completed[challengeId]) {
                  btn.textContent = "Completed";
                  btn.disabled = true;
                } else {
                  btn.textContent = "Complete Challenge";
                  btn.onclick = () => completeChallenge(challengeId, challengeDesc);
                }
                div.appendChild(btn);
                challengeListDiv.appendChild(div);
              });
            });
        });
    }

    // POST that a challenge is completed
    function completeChallenge(challengeId, challengeDesc) {
      if (!currentName || !currentTeam) {
        alert("Please login on the Edit tab first.");
        return;
      }
      fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({
          action: "completeChallenge",
          challengeId: challengeId,
          challengeDesc: challengeDesc,
          name: currentName,
          team: currentTeam
        })
      })
      .then(res => res.text())
      .then(response => {
        alert(response);
        loadChallenges(); // refresh
      })
      .catch(err => console.error(err));
    }

    // Auto-refresh the view tab every 10 seconds when it's active
    setInterval(() => {
      if (document.getElementById('view').classList.contains('active')) {
        fetchGolfScores();
        fetchChallengeRecords();
      }
    }, 10000);
  </script>
</body>
</html>
